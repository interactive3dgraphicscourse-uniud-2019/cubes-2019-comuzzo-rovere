<html>
	<head>
		<title>Starting Code for 1st Project 2017</title>
		<style>
		
		body {
			font-family: Monospace;
			background-color: #f0f0f0;
			margin: 0px;
			overflow: hidden;
		}
		
		canvas { 
			width: 100%; 
			height: 100%;
		}
	
	</style>
		<script src="lib/three.min.js"></script>
		<script src="lib/stats.min.js"></script>
		<script src="lib/Coordinates.js"></script>
		<script src="lib/OrbitControls.js"></script>
		<script src="Semaforo.js"></script>
		<script src="Linee.js"></script>
		<script src="Car.js"></script>
		<script src="lib/dat.gui.min.js"></script>
		<script src="Albero.js"></script>
		<script src="Pino.js"></script>
		<script src="Car_Queue.js"></script>
	</head>
	<body>
		
		<script>
		// COLORS;
		BLUE = 0x0000ff;
		SEMAPHORE_GREY = 0xcccccc;
		BLACK = 0x000000;
		
		RAD_TO_DEG_COEFF = Math.PI/180;
		ANGLE_90 = 90 * RAD_TO_DEG_COEFF;
		ANGLE_180 = 180 * RAD_TO_DEG_COEFF;
		ANGLE_270 = 270 * RAD_TO_DEG_COEFF;
		
		TICK_TIME = 3500;

		var crossroadRadius = 7;
		var roadLength = 67;
		var segmentSize = 6;
		var scene, camera, renderer, controls, stats;
		var crossroad, nord, sud, est, ovest;
		var gui, spawn;
		var lastTickTime;
		var carQueue, outQueue;


		var options = {
			spawnEast : 0.1,
			spawnWest : 0.1,
			spawnNorth : 0.1,
			spawnSouth : 0.1,
			VerdeSuZ: function() {
				if(est.stato=='G'){
					sud.setState(TRAFFIC_LIGHT_STATES.YELLOW.VAL);
					nord.setState(TRAFFIC_LIGHT_STATES.YELLOW.VAL);
					
					setTimeout(function(){
						est.setState(TRAFFIC_LIGHT_STATES.RED.VAL);
						ovest.setState(TRAFFIC_LIGHT_STATES.RED.VAL);

						sud.setState(TRAFFIC_LIGHT_STATES.GREEN.VAL);
						nord.setState(TRAFFIC_LIGHT_STATES.GREEN.VAL);
					}, 3500)
				}
			},
		  	VerdeSuX: function() {
				if(sud.stato=='G'){
					est.setState(TRAFFIC_LIGHT_STATES.YELLOW.VAL);
					ovest.setState(TRAFFIC_LIGHT_STATES.YELLOW.VAL);
					
					setTimeout(function(){
						sud.setState(TRAFFIC_LIGHT_STATES.RED.VAL);
						nord.setState(TRAFFIC_LIGHT_STATES.RED.VAL);
						est.setState(TRAFFIC_LIGHT_STATES.GREEN.VAL);
						ovest.setState(TRAFFIC_LIGHT_STATES.GREEN.VAL);
					}, 3500)
				}
			},
			

			
	};

	function Start() {
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );

			renderer = new THREE.WebGLRenderer( {antialias: true} );
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.setClearColor( 0xf0f0f0 );
			document.body.appendChild( renderer.domElement );
			
			camera.position.set(3,4,6);
			camera.lookAt( new THREE.Vector3(0,0,0));
			
			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			document.body.appendChild( stats.domElement );
			
			controls = new THREE.OrbitControls( camera );
			controls.addEventListener( 'change', Render );
			gui = new dat.GUI();
			gui.add(options, 'VerdeSuZ');
			gui.add(options, 'VerdeSuX');
			gui.add(options, 'spawnSouth' ,0 ,0.3 ,0.01).name("spawnrateSouth");
			gui.add(options, 'spawnEast' ,0 ,0.3 ,0.01).name("spawnrateEast");
			gui.add(options, 'spawnNorth' ,0 ,0.3 ,0.01).name("spawnrateNorth");
			gui.add(options, 'spawnWest' ,0 ,0.3 ,0.01).name("spawnrateWest");
			camera.position.z = 20;
			carEastQueue = new CarQueue(roadLength, segmentSize, crossroadRadius, PIVOT_DIST, scene, STREETS.EAST);
			carSouthQueue = new CarQueue(roadLength, segmentSize, crossroadRadius, PIVOT_DIST, scene, STREETS.SOUTH);
			carWestQueue = new CarQueue(roadLength, segmentSize, crossroadRadius, PIVOT_DIST, scene, STREETS.WEST);
			carNorthQueue = new CarQueue(roadLength, segmentSize, crossroadRadius, PIVOT_DIST, scene, STREETS.NORTH);
			outQueue = new OutQueue(roadLength, segmentSize, crossroadRadius, PIVOT_DIST, scene);
			
			crossroad = new CrossroadStreet(crossroadRadius, roadLength);
			sud = new trafficLight(crossroadRadius, crossroadRadius, 0);
			est = new trafficLight(crossroadRadius, -crossroadRadius, ANGLE_90);
			nord = new trafficLight(-crossroadRadius, -crossroadRadius, ANGLE_180);
			ovest = new trafficLight(-crossroadRadius, crossroadRadius, ANGLE_270);
			
			sud.setState(TRAFFIC_LIGHT_STATES.GREEN.VAL);
			est.setState(TRAFFIC_LIGHT_STATES.RED.VAL);
			nord.setState(TRAFFIC_LIGHT_STATES.GREEN.VAL);
			ovest.setState(TRAFFIC_LIGHT_STATES.RED.VAL);
			
			scene.add(crossroad.mainParent);
			scene.add(sud.mainParent);
			scene.add(est.mainParent);
			scene.add(nord.mainParent);
			scene.add(ovest.mainParent);
			
			carEastQueue.endTick(1);
			carEastQueue.startTick(0);
			carSouthQueue.endTick(1);
			carSouthQueue.startTick(0);
			carWestQueue.endTick(1);
			carWestQueue.startTick(0);
			carNorthQueue.endTick(1);
			carNorthQueue.startTick(0);
			lastTickTime = Date.now();

			for(var i=0; i<20; i++){
				xAlbero= crossroadRadius *1.5 +( Math.round( Math.random()* (roadLength- 2*crossroadRadius)));
				zAlbero= crossroadRadius *1.5 +( Math.round( Math.random()* (roadLength- 2*crossroadRadius)));
				var x = Math.round(Math.random() *3 );
				switch(x){

					case 0:
						if(Math.round(Math.random() )==0 ) {
							Albero1= new Albero(xAlbero,zAlbero);
							scene.add(Albero1.Tronco);		
						}else{
							Pino1=new Pino(xAlbero,zAlbero);
							scene.add(Pino1.Tronco);
						}
					break
					case 1:
						xAlbero*= -1;
						if(Math.round(Math.random() )==0 ) {
							Albero1= new Albero(xAlbero,zAlbero);
							scene.add(Albero1.Tronco);		
						}else{
							Pino1=new Pino(xAlbero,zAlbero);
							scene.add(Pino1.Tronco);
						}
					break
					case 2:
						zAlbero*= -1;
						if(Math.round(Math.random() )==0 ) {
							Albero1= new Albero(xAlbero,zAlbero);
							scene.add(Albero1.Tronco);		
						}else{
							Pino1=new Pino(xAlbero,zAlbero);
							scene.add(Pino1.Tronco);
						}
					break
					case 3:
						xAlbero*= -1;
						zAlbero*= -1;
						if(Math.round(Math.random() )==0 ) {
							Albero1= new Albero(xAlbero,zAlbero);
							scene.add(Albero1.Tronco);		
						}else{
							Pino1=new Pino(xAlbero,zAlbero);
							scene.add(Pino1.Tronco);
						}
					break
				}
			}
			
		}

		function Update() {
			requestAnimationFrame( Update );
			controls.update();  
			stats.update();
			var LiberoSouth=false;
			var LiberoNorth=false;
			var LiberoEast=false;
			var LiberoWest=false;


			var timeNow=Date.now();
			var passedTime = timeNow - lastTickTime;
			if(passedTime > TICK_TIME){
				carEastQueue.update(1);
				carSouthQueue.update(1);
				carWestQueue.update(1);
				carNorthQueue.update(1);
				outQueue.update(1);
				var crossedCar1 = carEastQueue.endTick(options.spawnEast);
				var crossedCar2 = carSouthQueue.endTick(options.spawnSouth);
				var crossedCar3 = carWestQueue.endTick(options.spawnWest);
				var crossedCar4 = carNorthQueue.endTick(options.spawnNorth);
				outQueue.endTick();
				if(crossedCar1 != 0){
					outQueue.add(crossedCar1);
				}
				if(crossedCar2 != 0){
					outQueue.add(crossedCar2);
				}
				if(crossedCar3 != 0){
					outQueue.add(crossedCar3);
				}
				if(crossedCar4 != 0){
					outQueue.add(crossedCar4);
				}

				//se uno va a Sx e l' altro no quello che va a Sx si ferma 


				if(   sud.stato!='G' || carSouthQueue.getHead()!=0 && (carSouthQueue.getHead().turnDir==TURN_DIR.LEFT && carNorthQueue.getHead().turnDir!=TURN_DIR.LEFT)){
					LiberoSouth= false;
				}else{
					LiberoSouth= true ;
				}

				if(nord.stato!='G' || carNorthQueue.getHead()!=0 &&  (carNorthQueue.getHead().turnDir==TURN_DIR.LEFT && carSouthQueue.getHead().turnDir!=TURN_DIR.LEFT)){
					LiberoNorth= false;
				}else{
					LiberoNorth= true ;
				}

				if(est.stato!='G' || carEastQueue.getHead()!=0 &&  (carEastQueue.getHead().turnDir==TURN_DIR.LEFT && carWestQueue.getHead().turnDir!=TURN_DIR.LEFT)){
					LiberoEast= false;
				}else{
					LiberoEast= true ;
				}

				if(ovest.stato!='G' || carWestQueue.getHead()!=0 && (carWestQueue.getHead().turnDir==TURN_DIR.LEFT && carEastQueue.getHead().turnDir!=TURN_DIR.LEFT) ){
					LiberoWest= false;
				}else{
					LiberoWest= true ;
				}

				
				carEastQueue.startTick(LiberoEast);
				carEastQueue.update((TICK_TIME - passedTime)/TICK_TIME);

				
				carSouthQueue.startTick(LiberoSouth);
				carSouthQueue.update((TICK_TIME - passedTime)/TICK_TIME);

			
				carWestQueue.startTick(LiberoWest);
				carWestQueue.update((TICK_TIME - passedTime)/TICK_TIME);

			
				carNorthQueue.startTick(LiberoNorth);
				carNorthQueue.update((TICK_TIME - passedTime)/TICK_TIME);

				outQueue.update((TICK_TIME - passedTime)/TICK_TIME);
				lastTickTime = timeNow ;
			} else {
				carEastQueue.update(passedTime/TICK_TIME);
				carSouthQueue.update(passedTime/TICK_TIME);
				carWestQueue.update(passedTime/TICK_TIME);
				carNorthQueue.update(passedTime/TICK_TIME);
				outQueue.update(passedTime/TICK_TIME);
			}
		
      Render();
    }
    
    function Render() {
      renderer.render(scene, camera);
    }
    
    Start();
    Update();
      
    </script>
  </body>
</html>